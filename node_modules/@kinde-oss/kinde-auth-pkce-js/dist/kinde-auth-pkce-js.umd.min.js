!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).createKindeClient=t()}(this,(function(){"use strict";const e="3.0.22",t="pkce-code-verifier";var r;async function o(e){return function(e){const t=Array.from(new Uint8Array(e));return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(await function(e){const t=(new TextEncoder).encode(e);return window.crypto.subtle.digest("SHA-256",t)}(e))}function n(){const e=new Uint32Array(28);return window.crypto.getRandomValues(e),Array.from(e,(e=>("0"+e.toString(16)).substr(-2))).join("")}!function(e){e.s="string",e.i="integer",e.b="boolean"}(r||(r={}));const a=e=>{try{return JSON.parse(atob(e.split(".")[1]))}catch(e){return null}},i=e=>{const t=Math.floor(Date.now()/1e3);return e.exp>t},s=(()=>{let e={};return{reset:()=>{e={}},getItem:t=>e[t],removeItem:t=>{delete e[t]},setItem:(t,r)=>{e[t]=r}}})(),c=(e,t="access_token")=>{const r=s.getItem(`kinde_${t}`);return r?{name:e,value:r[e]}:null},d=(e,t="access_token")=>{const r=c(e,t);return r&&r.value},l=(e,t,o)=>{const n=d("feature_flags"),a=n&&n[e]?n[e]:{};if(null==a.v&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(o&&a.t&&o!==a.t)throw Error(`Flag ${e} is of type ${r[a.t]} - requested type ${r[o]}`);return{code:e,type:r[a.t||o],value:null==a.v?t:a.v,is_default:null==a.v}},u=(e,t)=>{try{return l(e,t,"b").value}catch(e){return console.error(e),e}},_=(e,t)=>{try{return l(e,t,"i").value}catch(e){return console.error(e),e}},g=(e,t)=>{try{return l(e,t,"s").value}catch(e){return console.error(e),e}},f=()=>({orgCodes:d("org_codes","id_token")??[]});return async r=>{if(!r)throw Error("Please provide your Kinde credentials");if(r!==Object(r))throw Error("The Kinde SDK must be initiated with an object");const{audience:m,client_id:p,domain:h,is_dangerously_use_local_storage:w=!1,redirect_uri:y,logout_uri:k=y,on_redirect_callback:S,scope:v="openid profile email offline",_framework:$,_frameworkVersion:I}=r;if(m&&"string"!=typeof m)throw Error("Please supply a valid audience for your api");if(v&&"string"!=typeof v)throw Error("Please supply a valid scope");if(!y||"string"!=typeof r.redirect_uri)throw Error("Please supply a valid redirect_uri for your users to be redirected after successful authentication");if(!h||"string"!=typeof h)throw Error("Please supply a valid Kinde domain so we can connect to your account");if("boolean"!=typeof w)throw TypeError("Please supply a boolean value for is_dangerously_use_local_storage");const b=p||"spa@live",P=!w&&!h.includes(".kinde.com"),U={audience:m,client_id:b,redirect_uri:y,authorization_endpoint:`${h}/oauth2/auth`,token_endpoint:`${h}/oauth2/token`,requested_scopes:v,domain:h,_framework:$,_frameworkVersion:I},E=e=>{if(!e||e.error)return;const t=a(e.access_token),r=a(e.id_token);s.setItem("kinde_token",e),s.setItem("kinde_access_token",t),s.setItem("kinde_id_token",r),s.setItem("user",{id:r.sub,given_name:r.given_name,family_name:r.family_name,email:r.email,picture:r.picture}),w?localStorage.setItem("kinde_refresh_token",e.refresh_token):s.setItem("kinde_refresh_token",e.refresh_token)},T=async()=>{const t=w?localStorage.getItem("kinde_refresh_token"):s.getItem("kinde_refresh_token");if(t||P)try{const r=await fetch(U.token_endpoint,{method:"POST",...P&&{credentials:"include"},headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":`\n            ${U._framework||"JavaScript"}/${U._frameworkVersion||e}`}),body:new URLSearchParams({client_id:U.client_id,grant_type:"refresh_token",...!P&&t&&{refresh_token:t}})}),o=await r.json();return E(o),o.access_token}catch(e){console.error(e)}},C=async()=>{const e=s.getItem("kinde_token");if(!e)return await T();const t=s.getItem("kinde_access_token");return i(t)?e.access_token:await T()},K=async e=>{const{app_state:r,start_page:a,is_create_org:i,org_name:s="",org_code:c}=e,{state:d,code_challenge:l,url:u}=await(async(e,r)=>{const a=n(),i=n(),s=await o(i);return sessionStorage.setItem(`${t}-${a}`,JSON.stringify({codeVerifier:i,appState:r})),{state:a,code_challenge:s,url:new URL(e)}})(U.authorization_endpoint,r),_={redirect_uri:y,client_id:b,response_type:"code",scope:U.requested_scopes,code_challenge:l,code_challenge_method:"S256",state:d};a&&(_.start_page=a),m&&(_.audience=m),c&&(_.org_code=c),i&&(_.is_create_org=String(i),_.org_name=s),u.search=String(new URLSearchParams(_)),window.location.href=u.toString()},O=()=>s.getItem("user"),R=e=>{if(!e.has("code"))return!1;const{protocol:t,host:r,pathname:o}=window.location,n=`${t}//${r}${o}`;return n===y||n===`${y}/`};return await(async()=>{const r=new URLSearchParams(window.location.search);R(r)?await(async r=>{const o=r.get("code"),n=r.get("state"),a=r.get("error");a&&console.error(`Error returned from authorization server: ${a}`);const i=sessionStorage.getItem(`${t}-${n}`);if(i){const{appState:r,codeVerifier:a}=JSON.parse(i);try{const i=await fetch(U.token_endpoint,{method:"POST",...P&&{credentials:"include"},headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":`${U._framework||"JavaScript"}/${U._frameworkVersion||e}`}),body:new URLSearchParams({client_id:U.client_id,code:o,code_verifier:a,grant_type:"authorization_code",redirect_uri:U.redirect_uri})}),s=await i.json();E(s);const c=new URL(window.location.toString());c.search="",sessionStorage.removeItem(`${t}-${n}`);const d=O();window.history.pushState({},"",c),S&&S(d,r)}catch(e){console.error(e),sessionStorage.removeItem(`${t}-${n}`)}}else console.error("Invalid state")})(r):(P||w)&&await T()})(),{getToken:C,getUser:O,getUserProfile:async()=>{const e={Accept:"application/json",Authorization:`Bearer ${await C()}`};try{const t=await fetch(`${U.domain}/oauth2/v2/user_profile`,{method:"GET",headers:e}),r=await t.json();return s.setItem("user",{id:r.sub,given_name:r.given_name,family_name:r.family_name,email:r.email,picture:r.picture}),s.getItem("user")}catch(e){console.error(e)}},login:async e=>{await K({...e})},logout:async()=>{const e=new URL(`${U.domain}/logout`);try{s.reset(),w&&localStorage.removeItem("kinde_refresh_token");const t=new URLSearchParams({redirect:k});e.search=String(t),window.location.href=e.toString()}catch(e){console.error(e)}},register:async e=>{await K({...e,start_page:"registration"})},isAuthenticated:async()=>{const e=s.getItem("kinde_access_token");if(!e)return!1;return i(e)||await T(),!0},createOrg:async e=>{await K({...e,start_page:"registration",is_create_org:!0})},getClaim:c,getFlag:l,getBooleanFlag:u,getStringFlag:g,getIntegerFlag:_,getPermissions:()=>{const e=d("org_code");return{permissions:d("permissions")??[],orgCode:e}},getPermission:e=>{const t=d("org_code");return{isGranted:(d("permissions")??[]).some((t=>t===e)),orgCode:t}},getOrganization:()=>({orgCode:d("org_code")}),getUserOrganizations:f}}}));
